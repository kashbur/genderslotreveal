<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>The Big Reveal</title>
    <meta
      name="description"
      content="A fun surprise reveal with optional gender and language selection."
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@700&display=swap"
      rel="stylesheet"
    />
    <link rel="preload" as="image" href="img/Assets/background.png" />
    <link rel="preload" as="image" href="img/Assets/taptospin.png" />
    <link rel="preload" as="image" href="img/Assets/instructions.png" />
    <link rel="preload" as="image" href="img/Assets/blue-balloon.png" />
    <link rel="preload" as="image" href="img/Assets/bottle.png" />
    <link rel="preload" as="image" href="img/Assets/boy.png" />
    <link rel="preload" as="image" href="img/Assets/girl.png" />
    <link
      rel="preload"
      as="image"
      href="img/Assets/Spanish/background-spanish.png"
    />
    <link
      rel="preload"
      as="image"
      href="img/Assets/Spanish/taptospin-spanish.png"
    />
    <link
      rel="preload"
      as="image"
      href="img/Assets/Spanish/instructions-spanish.png"
    />
    <link
      rel="preload"
      as="image"
      href="img/Assets/Spanish/boy-spanish.png"
    />
    <link
      rel="preload"
      as="image"
      href="img/Assets/Spanish/girl-spanish.png"
    />
    <link
      rel="preload"
      as="image"
      href="img/Assets/French/background-french.png"
    />
    <link
      rel="preload"
      as="image"
      href="img/Assets/French/taptospin-french.png"
    />
    <link
      rel="preload"
      as="image"
      href="img/Assets/French/instructions-french.png"
    />
    <link
      rel="preload"
      as="image"
      href="img/Assets/French/boy-french.png"
    />
    <link
      rel="preload"
      as="image"
      href="img/Assets/French/girl-french.png"
    />
    <link
      rel="preload"
      as="image"
      href="img/Assets/German/background-german.png"
    />
    <link
      rel="preload"
      as="image"
      href="img/Assets/German/taptospin-german.png"
    />
    <link
      rel="preload"
      as="image"
      href="img/Assets/German/instructions-german.png"
    />
    <link
      rel="preload"
      as="image"
      href="img/Assets/German/boy-german.png"
    />
    <link
      rel="preload"
      as="image"
      href="img/Assets/German/girl-german.png"
    />
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/textfit/2.4.0/textFit.min.js"
      defer
    ></script>
    <style>
      :root {
        --font-family: 'Poppins';
        --icon-w: 112px;
        --icon-h: 112px;
        --spin-button-width: 34%;
        --spin-button-max-width: 170px;
        --spin-button-aspect: 2019 / 657;
        --instructions-max-width: 580px;
      }
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
        width: 100%;
        background: #f0f0f0;
        font-family: var(--font-family), sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
      }
      .aspect-container {
        position: relative;
        width: min(98vw, calc(98vh * 9 / 16));
        max-width: 430px;
        aspect-ratio: 9/16;
        height: auto;
        background: #ddd;
        box-shadow: 0 6px 24px rgba(0, 0, 0, 0.13);
        overflow: hidden;
        border-radius: 18px;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .slot-machine-container {
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: visible;
      }
      .slot-machine {
        position: absolute;
        width: 100%;
        height: 100%;
        background-image: none;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        transition: filter 0.5s ease;
        z-index: 1;
        pointer-events: none;
      }
      .blur-background {
        filter: blur(8px);
      }
      .reel {
        position: absolute;
        width: 19.2%;
        height: 14.4%;
        background: transparent;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2;
        transition: filter 0.5s ease;
        perspective: 600px;
        overflow: hidden;
      }
      .reel-inner {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        transition: transform 0.35s cubic-bezier(0.22, 0.61, 0.36, 1);
        overflow: hidden;
      }
      @keyframes slot-spin-down {
        0% {
          transform: translateY(-20%);
        }
        100% {
          transform: translateY(0);
        }
      }
      .reel-strip.spinning {
        animation: slot-spin-down 0.2s linear infinite;
      }
      .reel-strip {
        display: flex;
        flex-direction: column;
        align-items: center;
        will-change: transform;
        transform: translate3d(0, 0, 0);
        backface-visibility: hidden;
        contain: paint;
        overflow: hidden;
      }
      .reel-item {
        height: 100%;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      #reel1 {
        left: 20.4%;
        top: 33.9%;
      }
      #reel2 {
        left: 42.7%;
        top: 33.9%;
      }
      #reel3 {
        left: 65.1%;
        top: 33.9%;
      }
      .reel img {
        max-width: 75%;
        max-height: 75%;
        object-fit: contain;
        display: block;
        margin: auto;
      }
      .reel-icon {
        width: auto;
        height: auto;
        background: transparent;
      }
      .spin-button {
        position: absolute;
        width: var(--spin-button-width);
        max-width: var(--spin-button-max-width);
        left: 50%;
        top: 62.5%;
        transform: translateX(-50%);
        cursor: pointer;
        filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.18));
        z-index: 3;
        transition:
          all 0.08s,
          filter 0.5s ease;
      }
      .spin-button img {
        width: 100%;
        height: auto;
        aspect-ratio: var(--spin-button-aspect);
        object-fit: contain;
        display: block;
        border-radius: 0;
        background: transparent;
        box-shadow: none;
      }
      .spin-button.pressed,
      .spin-button:active {
        transform: translateX(-50%) scale(0.95);
      }
      .reveal-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: transparent;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 1vh;
        gap: 1vh;
        box-sizing: border-box;
        z-index: 10;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s;
      }
      .reveal-overlay .color-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border-radius: inherit;
        z-index: 0;
        pointer-events: none;
        opacity: 1;
        background: transparent;
        transition: background 0.3s;
      }
      .intro-overlay {
        transition: opacity 0.4s;
      }
      .reveal-lines {
        position: relative;
        z-index: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        width: min(84%, 360px);
        height: 100%;
        gap: 2vh;
        padding: 2vh 3vw;
        margin: 0 auto;
        box-sizing: border-box;
        text-align: center;
      }

      .reveal-line {
        flex: 0 0 auto;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        text-align: center;
        white-space: normal;
        overflow-wrap: normal;
        text-wrap: balance;
        font-family: var(--font-family), sans-serif;
        color: #fff;
        margin: 0;
        line-height: 1.15;
        animation: reveal-pulse 2.8s ease-in-out infinite;
        transform-origin: center;
        will-change: transform, opacity;
      }
      @keyframes reveal-pulse {
        0%,
        100% {
          transform: scale(1);
          opacity: 1;
        }
        50% {
          transform: scale(1.06);
          opacity: 0.9;
        }
      }
      @media (prefers-reduced-motion: reduce) {
        .reveal-line {
          animation: none;
        }
      }
      .reveal-line.main {
        line-height: 1.1;
        font-weight: 900;
        text-transform: uppercase;
      }
      .reveal-line.sub {
        font-weight: 700;
        text-transform: uppercase;
      }
      .reveal-line.date {
        font-weight: 700;
      }
      .reveal-line.from {
        font-weight: 700;
        font-style: italic;
        margin-top: 0;
        color: #fff;
      }
      @media (max-width: 500px) {
        .aspect-container {
          max-width: 100vw;
        }
        .instructions-container {
          max-width: 96vw;
        }
        .reveal-overlay {
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          border-radius: 0;
        }
        .reveal-lines {
          padding-top: calc(2vh + env(safe-area-inset-top, 1vh));
        }
      }
      .confetti {
        position: absolute;
        z-index: 101;
        will-change: transform, opacity;
        pointer-events: none;
      }
      .confetti-square {
        width: 10px;
        height: 10px;
      }
      .confetti-rectangle {
        width: 8px;
        height: 16px;
      }
      .confetti-circle {
        width: 10px;
        height: 10px;
        border-radius: 50%;
      }

      .gender-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.6);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        padding: 2vh 6vw;
        box-sizing: border-box;
        z-index: 12;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.4s;
      }
      .gender-text {
        --gender-text-color: #ffa98e;
        --gender-outline-color: rgba(255, 255, 255, 0.95);
        font-family: 'Arial Rounded MT Bold', 'Arial', sans-serif;
        font-weight: bold;
        color: var(--gender-text-color);
        text-shadow: -0.08em -0.08em 0 var(--gender-outline-color),
          0.08em -0.08em 0 var(--gender-outline-color),
          -0.08em 0.08em 0 var(--gender-outline-color),
          0.08em 0.08em 0 var(--gender-outline-color);
        -webkit-text-stroke: 0.04em var(--gender-outline-color);
        font-size: clamp(32px, 8vw, 80px);
        width: 100%;
        max-width: 100%;
        text-align: center;
        animation: gender-bounce 0.6s ease-in-out 3;
        display: flex;
        align-items: center;
        justify-content: center;
        text-wrap: balance;
        word-break: break-word;
        line-height: 1.05;
        margin: 0;
        box-sizing: border-box;
      }
      .gender-overlay[data-gender='boy'] .gender-text {
        --gender-text-color: #7dc7ff;
        --gender-outline-color: rgba(37, 110, 187, 0.88);
      }
      .gender-overlay[data-gender='girl'] .gender-text {
        --gender-text-color: #ffa98e;
        --gender-outline-color: rgba(255, 255, 255, 0.95);
      }
      @keyframes gender-bounce {
        0%, 100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }
      /* Instructions Overlay */
      .instructions-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.68);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 20;
        cursor: pointer;
        transition: opacity 0.4s;
      }
      .instructions-container {
        width: 97%;
        max-width: var(--instructions-max-width);
        position: relative;
      }
      .instructions-image {
        width: 100%;
        height: auto;
        aspect-ratio: 1 / 1;
        object-fit: contain;
        border-radius: 12px;
        /* box-shadow: none; */
        /* border: none; */
      }
    </style>
  </head>
  <body>
    <div class="aspect-container">
      <div class="slot-machine-container">
        <div class="slot-machine blur-background" id="slotMachine"></div>
        <div id="reel1" class="reel blur-background"></div>
        <div id="reel2" class="reel blur-background"></div>
        <div id="reel3" class="reel blur-background"></div>
        <div class="spin-button blur-background" id="spinButton">
          <img
            src="data:image/gif;base64,R0lGODlhAQABAAAAACw="
            alt="Spin"
            decoding="async"
            fetchpriority="high"
            loading="eager"
            style="visibility: hidden"
          />
        </div>
        <div class="reveal-overlay intro-overlay" id="introOverlay">
          <div class="color-overlay"></div>
          <div class="reveal-lines" id="introLines"></div>
        </div>
        <div class="reveal-overlay" id="revealOverlay">
          <div class="color-overlay" id="colorOverlay"></div>
          <div class="reveal-lines" id="revealLines"></div>
        </div>
        <div class="gender-overlay" id="genderOverlay">
          <div class="gender-text">IT'S A GIRL!</div>
        </div>
        <div
          class="instructions-overlay"
          id="instructionsOverlay"
          style="opacity: 1"
        >
          <div class="instructions-container">
            <img
              src="data:image/gif;base64,R0lGODlhAQABAAAAACw="
              alt="Instructions"
              class="instructions-image"
              decoding="async"
              loading="eager"
              fetchpriority="high"
              style="visibility: hidden"
            />
          </div>
        </div>
      </div>
    </div>
    <script>
      const imageCache = new Map();
      const ICON_BOX_DIMENSIONS = {
        width: 112,
        height: 112,
      };

      function syncIconDimensionsWithCSS() {
        if (!window.getComputedStyle) return;
        const styles = getComputedStyle(document.documentElement);
        const widthValue = parseFloat(styles.getPropertyValue("--icon-w"));
        const heightValue = parseFloat(styles.getPropertyValue("--icon-h"));
        if (!Number.isNaN(widthValue)) {
          ICON_BOX_DIMENSIONS.width = widthValue;
        }
        if (!Number.isNaN(heightValue)) {
          ICON_BOX_DIMENSIONS.height = heightValue;
        }
      }

      function loadImage(src, priority = "auto") {
        const cached = imageCache.get(src);
        if (cached) {
          if (
            priority === "high" &&
            cached.img &&
            "fetchPriority" in cached.img
          ) {
            cached.img.fetchPriority = "high";
          }
          return cached.promise;
        }
        const img = new Image();
        if ("decoding" in img) {
          img.decoding = "async";
        }
        if ("fetchPriority" in img) {
          img.fetchPriority = priority;
        }
        const loadPromise = new Promise((resolve) => {
          img.addEventListener("load", resolve, { once: true });
          img.addEventListener("error", resolve, { once: true });
        });
        img.src = src;
        let promise = loadPromise;
        if (typeof img.decode === "function") {
          promise = img.decode().catch(() => loadPromise);
        }
        const finalPromise = promise.then(() => {});
        imageCache.set(src, { img, promise: finalPromise });
        return finalPromise;
      }

      function preloadImages(urls, priority = "auto") {
        return Promise.all(urls.map((url) => loadImage(url, priority)));
      }

      function createIconElement(
        src,
        { alt = "Slot Icon", priority = "auto" } = {},
      ) {
        const img = document.createElement("img");
        const cached = imageCache.get(src);
        img.src = cached && cached.img ? cached.img.currentSrc || src : src;
        img.alt = alt;
        img.classList.add("reel-icon");
        img.width = ICON_BOX_DIMENSIONS.width;
        img.height = ICON_BOX_DIMENSIONS.height;
        if ("decoding" in img) {
          img.decoding = "async";
        }
        if ("loading" in img) {
          img.loading = priority === "high" ? "eager" : "lazy";
        }
        if ("fetchPriority" in img) {
          img.fetchPriority = priority;
        }
        return img;
      }

      function getParams() {
        const url = new URL(window.location.href);
        const langParam = (
          url.searchParams.get("lang") || url.searchParams.get("language") || ""
        ).toLowerCase();
        const genderParam = (url.searchParams.get("gender") || "").toLowerCase();
        return { lang: langParam, gender: genderParam };
      }

      const params = getParams();
      const normalizedLanguage = params.lang.split(/[-_]/)[0] || "";

      const LANGUAGE_ASSET_MAP = {
        en: {
          background: "img/Assets/background.png",
          tapToSpin: "img/Assets/taptospin.png",
          instructions: "img/Assets/instructions.png",
          boyIcon: "img/Assets/boy.png",
          girlIcon: "img/Assets/girl.png",
        },
        es: {
          background: "img/Assets/Spanish/background-spanish.png",
          tapToSpin: "img/Assets/Spanish/taptospin-spanish.png",
          instructions: "img/Assets/Spanish/instructions-spanish.png",
          boyIcon: "img/Assets/Spanish/boy-spanish.png",
          girlIcon: "img/Assets/Spanish/girl-spanish.png",
        },
        fr: {
          background: "img/Assets/French/background-french.png",
          tapToSpin: "img/Assets/French/taptospin-french.png",
          instructions: "img/Assets/French/instructions-french.png",
          boyIcon: "img/Assets/French/boy-french.png",
          girlIcon: "img/Assets/French/girl-french.png",
        },
        de: {
          background: "img/Assets/German/background-german.png",
          tapToSpin: "img/Assets/German/taptospin-german.png",
          instructions: "img/Assets/German/instructions-german.png",
          boyIcon: "img/Assets/German/boy-german.png",
          girlIcon: "img/Assets/German/girl-german.png",
        },
      };

      const STATIC_ICON_SOURCES = [
        "img/Assets/blue-balloon.png",
        "img/Assets/bottle.png",
        { key: "boyIcon" },
        "img/Assets/confetti.png",
        "img/Assets/elephant.png",
        { key: "girlIcon" },
        "img/Assets/pink-balloon.png",
        "img/Assets/rainbow.png",
        "img/Assets/teddy-bear.png",
      ];

      function resolveLanguageAssets(languageCode) {
        if (languageCode && LANGUAGE_ASSET_MAP[languageCode]) {
          return LANGUAGE_ASSET_MAP[languageCode];
        }
        return LANGUAGE_ASSET_MAP.en;
      }

      function buildIconSources(config) {
        return STATIC_ICON_SOURCES.map((source) =>
          typeof source === "string" ? source : config[source.key],
        );
      }

      const languageAssets = resolveLanguageAssets(normalizedLanguage);
      const englishAssets = LANGUAGE_ASSET_MAP.en;
      const ICON_SOURCES = buildIconSources(languageAssets);
      const ENGLISH_ICON_SOURCES = buildIconSources(englishAssets);
      const CRITICAL_IMAGE_SOURCES = [
        languageAssets.background,
        languageAssets.tapToSpin,
        languageAssets.instructions,
        languageAssets.boyIcon,
        languageAssets.girlIcon,
      ];
      const ENGLISH_CRITICAL_IMAGE_SOURCES = [
        englishAssets.background,
        englishAssets.tapToSpin,
        englishAssets.instructions,
        englishAssets.boyIcon,
        englishAssets.girlIcon,
      ];
      const ALL_IMAGE_SOURCES = Array.from(
        new Set([
          ...ICON_SOURCES,
          ...ENGLISH_ICON_SOURCES,
          ...CRITICAL_IMAGE_SOURCES,
          ...ENGLISH_CRITICAL_IMAGE_SOURCES,
        ]),
      );
      const assetPreloadPromise = preloadImages(ALL_IMAGE_SOURCES, "high").catch(
        () => {},
      );

      function buildRevealLines(defaults = {}) {
        const lines = [];
        const main = defaults.main || "We are expecting!";
        const sub = defaults.sub || "";
        const date = defaults.date || "";
        const from = defaults.from || "";
        if (main) lines.push({ type: "main", content: main });
        if (sub) lines.push({ type: "sub", content: sub });
        if (date) lines.push({ type: "date", content: date });
        if (from) lines.push({ type: "from", content: from });
        return lines;
      }

      document.addEventListener("DOMContentLoaded", function () {
        syncIconDimensionsWithCSS();
        const translations = {
          en: {
            htmlLang: "en",
            revealDefaults: {
              main: "We are expecting!",
              sub: "",
              date: "",
              from: "",
            },
            gender: {
              boy: "IT'S A BOY!",
              girl: "IT'S A GIRL!",
            },
          },
          es: {
            htmlLang: "es",
            revealDefaults: {
              main: "¡Estamos esperando!",
              sub: "",
              date: "",
              from: "",
            },
            gender: {
              boy: "¡ES UN NIÑO!",
              girl: "¡ES UNA NIÑA!",
            },
          },
          fr: {
            htmlLang: "fr",
            revealDefaults: {
              main: "Nous attendons un bébé !",
              sub: "",
              date: "",
              from: "",
            },
            gender: {
              boy: "C'EST UN GARÇON !",
              girl: "C'EST UNE FILLE !",
            },
          },
          de: {
            htmlLang: "de",
            revealDefaults: {
              main: "Wir erwarten ein Baby!",
              sub: "",
              date: "",
              from: "",
            },
            gender: {
              boy: "ES IST EIN JUNGE!",
              girl: "ES IST EIN MÄDCHEN!",
            },
          },
          pt: {
            htmlLang: "pt",
            revealDefaults: {
              main: "Estamos esperando!",
              sub: "",
              date: "",
              from: "",
            },
            gender: {
              boy: "É UM MENINO!",
              girl: "É UMA MENINA!",
            },
          },
          it: {
            htmlLang: "it",
            revealDefaults: {
              main: "Aspettiamo un bambino!",
              sub: "",
              date: "",
              from: "",
            },
            gender: {
              boy: "È UN MASCHIETTO!",
              girl: "È UNA FEMMINUCCIA!",
            },
          },
          nl: {
            htmlLang: "nl",
            revealDefaults: {
              main: "We verwachten een baby!",
              sub: "",
              date: "",
              from: "",
            },
            gender: {
              boy: "HET IS EEN JONGEN!",
              girl: "HET IS EEN MEISJE!",
            },
          },
          sv: {
            htmlLang: "sv",
            revealDefaults: {
              main: "Vi väntar barn!",
              sub: "",
              date: "",
              from: "",
            },
            gender: {
              boy: "DET ÄR EN POJKE!",
              girl: "DET ÄR EN FLICKA!",
            },
          },
          ar: {
            htmlLang: "ar",
            dir: "rtl",
            revealDefaults: {
              main: "نحن ننتظر!",
              sub: "",
              date: "",
              from: "",
            },
            gender: {
              boy: "إنه صبي!",
              girl: "إنها فتاة!",
            },
          },
        };
        const locale = translations[normalizedLanguage] || translations.en;
        const htmlLang = locale.htmlLang || normalizedLanguage || "en";
        document.documentElement.setAttribute("lang", htmlLang);
        if (locale.dir) {
          document.documentElement.setAttribute("dir", locale.dir);
        } else {
          document.documentElement.removeAttribute("dir");
        }
        const revealDefaults =
          locale.revealDefaults || translations.en.revealDefaults;
        const genderTranslations = locale.gender || translations.en.gender;

        const icons = ICON_SOURCES;
        preloadImages(icons).catch(() => {});

        function getRandomIcon() {
          return icons[Math.floor(Math.random() * icons.length)];
        }

        function createSingleIcon(reel, icon) {
          reel.innerHTML = "";
          const inner = document.createElement("div");
          inner.className = "reel-inner";
          inner.appendChild(
            createIconElement(icon, { alt: "Slot Icon", priority: "high" }),
          );
          reel.appendChild(inner);
        }

        function createReelStrip(reel) {
          reel.innerHTML = "";
          const strip = document.createElement("div");
          strip.className = "reel-strip";
          for (let i = 0; i < 10; i++) {
            const item = document.createElement("div");
            item.className = "reel-item";
            const img = createIconElement(getRandomIcon(), {
              alt: "Slot Icon",
              priority: "low",
            });
            item.appendChild(img);
            strip.appendChild(item);
          }
          reel.appendChild(strip);
          return strip;
        }

        let spinCount = 0;
        let currentSymbols = [];
        const slotMachine = document.getElementById("slotMachine");
        const spinButton = document.getElementById("spinButton");
        const reels = [];
        for (let i = 1; i <= 3; i++) {
          reels.push(document.getElementById(`reel${i}`));
        }
        const introOverlay = document.getElementById("introOverlay");
        const introLinesDiv = document.getElementById("introLines");
        const introColorOverlay = introOverlay.querySelector(".color-overlay");
        const revealOverlay = document.getElementById("revealOverlay");
        const revealLinesDiv = document.getElementById("revealLines");
        const colorOverlay = document.getElementById("colorOverlay");
        const instructionsOverlay = document.getElementById(
          "instructionsOverlay",
        );
        const spinButtonImage = spinButton
          ? spinButton.querySelector("img")
          : null;
        const instructionsImage = instructionsOverlay
          ? instructionsOverlay.querySelector(".instructions-image")
          : null;
        if (spinButtonImage) {
          spinButtonImage.style.visibility = "hidden";
        }
        if (instructionsImage) {
          instructionsImage.style.visibility = "hidden";
        }

        function populateInitialReels() {
          if (!reels.length) return;
          const initialIcons = [icons[0], icons[1], icons[2]];
          reels.forEach((reel, index) => {
            const icon = initialIcons[index] || getRandomIcon();
            createSingleIcon(reel, icon);
          });
        }

        function applyLocalizedAssets() {
          if (slotMachine) {
            slotMachine.style.backgroundImage = `url("${languageAssets.background}")`;
          }
          if (spinButtonImage) {
            spinButtonImage.src = languageAssets.tapToSpin;
            spinButtonImage.style.visibility = "visible";
          }
          if (instructionsImage) {
            instructionsImage.src = languageAssets.instructions;
            instructionsImage.style.visibility = "visible";
          }
          populateInitialReels();
        }
        assetPreloadPromise.then(applyLocalizedAssets);
        const genderOverlay = document.getElementById("genderOverlay");
        const genderText = genderOverlay.querySelector(".gender-text");
        const isGirl = params.gender === "2";
        const isBoy = params.gender === "1";
        function setGenderState() {
          if (isBoy) {
            genderText.textContent = genderTranslations.boy;
            genderOverlay.setAttribute("data-gender", "boy");
          } else if (isGirl) {
            genderText.textContent = genderTranslations.girl;
            genderOverlay.setAttribute("data-gender", "girl");
          } else {
            genderText.textContent = "";
            genderOverlay.removeAttribute("data-gender");
          }
        }
        setGenderState();
        const safeTextColor = "#ffffff";
        const safeOutlineColor = "#7e5e4f";

        const lineColors = {
          main: {
            text: safeTextColor,
            outline: safeOutlineColor,
          },
          sub: {
            text: safeTextColor,
            outline: safeOutlineColor,
          },
          date: {
            text: safeTextColor,
            outline: safeOutlineColor,
          },
          from: {
            text: safeTextColor,
            outline: safeOutlineColor,
          },
        };
        const fonts = {
          main: "'Poppins'",
          sub: "'Poppins'",
          date: "'Poppins'",
          from: "'Poppins'",
        };
        const audioContext = new (window.AudioContext ||
          window.webkitAudioContext)();

        // Set overlay color on reveal
        const overlayColor = "#f3ddbb";
        colorOverlay.style.background = overlayColor;
        introColorOverlay.style.background = overlayColor;

        // Hide instructions overlay
        function hideInstructionsOverlay() {
          instructionsOverlay.style.opacity = "0";
          slotMachine.classList.remove("blur-background");
          reels.forEach((r) => r.classList.remove("blur-background"));
          spinButton.classList.remove("blur-background");
          instructionsOverlay.style.pointerEvents = "none";
          setTimeout(() => {
            if (instructionsOverlay.parentNode)
              instructionsOverlay.parentNode.removeChild(instructionsOverlay);
          }, 400);
        }
        instructionsOverlay.addEventListener("click", hideInstructionsOverlay);
        instructionsOverlay.addEventListener(
          "touchstart",
          function (e) {
            e.preventDefault();
            hideInstructionsOverlay();
          },
          { passive: false },
        );

        // Spin button interactions
        function playClickSound() {
          try {
            if (audioContext.state === "suspended") {
              audioContext.resume();
            }
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.type = "sine";
            oscillator.frequency.setValueAtTime(210, audioContext.currentTime);
            gainNode.gain.setValueAtTime(0.14, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(
              0.001,
              audioContext.currentTime + 0.14,
            );
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.14);
          } catch (e) {}
        }
        spinButton.addEventListener("mousedown", function () {
          this.classList.add("pressed");
          if (navigator.vibrate) navigator.vibrate(24);
          playClickSound();
        });
        spinButton.addEventListener("mouseup", function () {
          this.classList.remove("pressed");
        });
        spinButton.addEventListener("mouseleave", function () {
          this.classList.remove("pressed");
        });
        spinButton.addEventListener(
          "touchstart",
          function (e) {
            e.preventDefault();
            this.classList.add("pressed");
            if (navigator.vibrate) navigator.vibrate(24);
            playClickSound();
          },
          { passive: false },
        );
        spinButton.addEventListener(
          "touchend",
          function (e) {
            e.preventDefault();
            this.classList.remove("pressed");
            handleSpin();
          },
          { passive: false },
        );
        spinButton.addEventListener("click", handleSpin);

        function handleSpin() {
          spinCount++;
          spinButton.style.pointerEvents = "none";
          const spinDuration = 900;
          const delayStep = 600;
          if (spinCount === 4) {
            let finalIcon = icons[1];
            if (isGirl) finalIcon = icons[5];
            else if (isBoy) finalIcon = icons[2];
            const endCallback =
              isGirl || isBoy
                ? () => setTimeout(showGenderReveal, 500)
                : () => setTimeout(showReveal, 500);
            reels.forEach((reel, i) => {
              const delay = i * delayStep;
              const callback = i === reels.length - 1 ? endCallback : null;
              spinReel(reel, delay, spinDuration, finalIcon, callback);
            });
            currentSymbols = reels.map(() => finalIcon);
          } else {
            generateRandomNonMatchingSymbols();
            reels.forEach((reel, i) => {
              const delay = i * delayStep;
              spinReel(reel, delay, spinDuration, currentSymbols[i]);
            });
          }
          const pointerDelay =
            delayStep * (reels.length - 1) + spinDuration + (spinCount === 4 ? 500 : 0);
          setTimeout(() => {
            spinButton.style.pointerEvents = "auto";
          }, pointerDelay);
        }
        function generateRandomNonMatchingSymbols() {
          let symbols;
          if (spinCount < 4) {
            do {
              symbols = reels.map(() => getRandomIcon());
            } while (new Set(symbols).size < 2); // avoid 3-of-a-kind
          } else {
            symbols = reels.map(() => getRandomIcon());
          }
          currentSymbols = symbols;
        }
        function spinReel(reel, delay, duration, finalIcon, callback) {
          setTimeout(() => {
            const strip = createReelStrip(reel);
            strip.classList.add("spinning");
            setTimeout(() => {
              strip.classList.remove("spinning");
              createSingleIcon(reel, finalIcon || getRandomIcon());
              if (callback) callback();
            }, duration);
          }, delay);
        }

        function readingDelay(text, wps = 110) {
          const words = text.trim().split(/\s+/).filter(Boolean).length || 1;
          // (words ÷ wps) seconds  + 0.8 s buffer, clamped 1.6-6 s
          const ms = Math.round((words / wps) * 1000) + 800;
          return Math.max(1600, Math.min(ms, 6000));
        }

        function fitRevealLine(el, type) {
          textFit(el, {
            alignVert: true,
            alignHoriz: true,
            multiLine: true,
            detectMultiLine: true,
            minFontSize: 12,
            maxFontSize: 50,
          });
        }

        function refitAllLines() {
          document.querySelectorAll(".reveal-line").forEach((el) => {
            const type = Array.from(el.classList).find((c) => c !== "reveal-line");
            fitRevealLine(el, type);
          });
        }

        if (document.fonts && document.fonts.ready) {
          document.fonts.ready.then(refitAllLines);
        }

        function applyTextStyles(el, color, outlineColor, fontFamily) {
          el.style.color = color;
          if (outlineColor === "transparent") {
            el.style.textShadow = "none";
            el.style.webkitTextStroke = "0";
          } else {
            el.style.textShadow = `-1px -1px 0 ${outlineColor}, 1px -1px 0 ${outlineColor}, -1px 1px 0 ${outlineColor}, 1px 1px 0 ${outlineColor}`;
            el.style.webkitTextStroke = `1px ${outlineColor}`;
          }
          if (fontFamily) {
            el.style.fontFamily = `${fontFamily}, sans-serif`;
          }
        }

        // ------------- REVEAL LOGIC -----------------
        function showReveal() {
          const allLines = buildRevealLines(revealDefaults);
          const mainLine = allLines.find((l) => l.type === "main");
          const otherLines = allLines.filter((l) => l.type !== "main");
          let confettiShown = false;

          function showStageTwo() {
            revealLinesDiv.innerHTML = "";

            function addLine(line) {
              const div = document.createElement("div");
              div.className = "reveal-line " + line.type;
              div.textContent =
                line.type === "sub" ? line.content.toUpperCase() : line.content;
              const colors = lineColors[line.type] || { text: safeTextColor, outline: safeOutlineColor };
              applyTextStyles(div, colors.text, colors.outline, fonts[line.type]);
              div.style.margin = "0";
              revealLinesDiv.appendChild(div);
              fitRevealLine(div, line.type);
            }
            const subLine = otherLines.find((l) => l.type === "sub");
            const dateLine = otherLines.find((l) => l.type === "date");
            const fromLine = otherLines.find((l) => l.type === "from");
            [subLine, dateLine, fromLine]
              .filter(Boolean)
              .forEach(addLine);
            const hideDelay = 30000;



            revealOverlay.style.opacity = "1";
            revealOverlay.style.pointerEvents = "auto";
            refitAllLines();
            if (!confettiShown) {
              createConfetti();
              confettiShown = true;
            }
            setTimeout(() => {
              revealOverlay.style.opacity = "0";
              revealOverlay.style.pointerEvents = "none";
            }, hideDelay);
          }

          if (mainLine) {
            introLinesDiv.innerHTML = "";
            const div = document.createElement("div");
            div.className = "reveal-line main";
            div.textContent = mainLine.content;
            applyTextStyles(div, lineColors.main.text, lineColors.main.outline, fonts.main);
            introLinesDiv.appendChild(div);
            fitRevealLine(div, "main");
            introOverlay.style.opacity = "1";
            introOverlay.style.pointerEvents = "auto";
            refitAllLines();
            if (!confettiShown) {
              createConfetti();
              confettiShown = true;
            }
            const headline = mainLine.content;
            function proceed() {
              introOverlay.style.opacity = "0";
              introOverlay.style.pointerEvents = "none";
              setTimeout(showStageTwo, 400);
            }
            setTimeout(proceed, readingDelay(headline));
          } else {
            setTimeout(showStageTwo, 100);
          }
        }

        function showGenderReveal() {
          genderOverlay.style.opacity = "1";
          genderOverlay.style.pointerEvents = "auto";
          setGenderState();
          if (isBoy) {
            genderOverlay.style.background = "rgba(203, 226, 207, 0.6)";
            createConfetti(["#cbe2cf", "#ffffff", "#ffd700"]);
          } else {
            genderOverlay.style.background = "rgba(255, 255, 255, 0.6)";
            createConfetti([
              "#ffa98e",
              "#FFB6C1",
              "#FFC0CB",
              "#FFFFFF",
              "#FF1493",
              "#DB7093",
            ]);
          }
          setTimeout(() => {
            genderOverlay.style.opacity = "0";
            genderOverlay.style.pointerEvents = "none";
          }, 8000);
        }
        // -------- Confetti logic (unchanged) ----------
        function createConfetti(customColors) {
          document.querySelectorAll(".confetti").forEach((el) => {
            if (el.parentNode) el.parentNode.removeChild(el);
          });
          const colors = customColors || [
            "#FFD700",
            "#FFC125",
            "#EEC900",
            "#CDAD00",
            "#8B7500",
            "#DAA520",
            "#B8860B",
            "#A67C00",
            "#BDB76B",
            "#F0E68C",
            "#C0C0C0",
            "#D3D3D3",
            "#DCDCDC",
            "#E8E8E8",
            "#A9A9A9",
            "#B5B5B5",
            "#E0E0E0",
            "#F5F5F5",
            "#EBEBEB",
            "#CCCCCC",
          ];
          const container = document.querySelector(".slot-machine-container");
          const confettiElements = [];
          const viewportWidth = container.offsetWidth,
            viewportHeight = container.offsetHeight;
          const confettiCount = 64;
          for (let i = 0; i < confettiCount; i++) {
            const confetti = document.createElement("div");
            const shapeType = Math.floor(Math.random() * 3);
            confetti.className =
              shapeType === 0
                ? "confetti confetti-square"
                : shapeType === 1
                  ? "confetti confetti-rectangle"
                  : "confetti confetti-circle";
            const left =
              (i / confettiCount) * viewportWidth + (Math.random() * 16 - 8);
            const top = -18 - Math.random() * 35;
            const size = 6 + Math.random() * 6;
            const scale = 0.7 + Math.random() * 0.6;
            const color = colors[Math.floor(Math.random() * colors.length)];
            const rotation = Math.random() * 360;
            confetti.style.left = `${left}px`;
            confetti.style.top = `${top}px`;
            if (shapeType === 0) {
              confetti.style.width = `${size}px`;
              confetti.style.height = `${size}px`;
            } else if (shapeType === 1) {
              confetti.style.width = `${size * 0.5}px`;
              confetti.style.height = `${size * 1.5}px`;
            } else {
              confetti.style.width = `${size}px`;
              confetti.style.height = `${size}px`;
            }
            confetti.style.backgroundColor = color;
            confetti.style.transform = `rotate(${rotation}deg) scale(${scale})`;
            confetti.style.boxShadow = "0 0 4px rgba(255,255,255,0.7)";
            container.appendChild(confetti);
            confettiElements.push({
              element: confetti,
              speed: 1.3 + Math.random() * 1.1,
              rotationSpeed: -0.5 + Math.random() * 1,
              horizontalDrift: -2 + Math.random() * 4,
              horizontalWobble: Math.random() * 2,
              wobbleSpeed: 0.25 + Math.random() * 0.45,
              floatFactor: 0.8 + Math.random() * 0.4,
              x: left,
              y: top,
              rotation: rotation,
              gravity: 0.05 + Math.random() * 0.04,
              airResistance: 0.97 + Math.random() * 0.02,
            });
          }
          let lastTime = performance.now(),
            animationFrameId;
          function animateAllConfetti(currentTime) {
            const deltaTime = Math.min((currentTime - lastTime) / 16.67, 2);
            lastTime = currentTime;
            let activeConfetti = false;
            confettiElements.forEach((confetti) => {
              if (confetti.y < viewportHeight + 44) {
                activeConfetti = true;
                confetti.speed += confetti.gravity * deltaTime;
                confetti.horizontalDrift *= confetti.airResistance;
                confetti.y += confetti.speed * deltaTime * confetti.floatFactor;
                confetti.x += confetti.horizontalDrift * 0.06 * deltaTime;
                const wobblePhase = confetti.y * 0.005 * confetti.wobbleSpeed;
                const wobble =
                  Math.sin(wobblePhase) * confetti.horizontalWobble;
                confetti.rotation += confetti.rotationSpeed * 0.5 * deltaTime;
                const el = confetti.element;
                el.style.top = `${confetti.y}px`;
                el.style.left = `${confetti.x + wobble}px`;
                const scale =
                  el.style.transform.match(/scale\(([^)]+)\)/)?.[1] || 1;
                el.style.transform = `rotate(${confetti.rotation}deg) scale(${scale})`;
                const shimmer = 0.8 + Math.sin(confetti.y * 0.006) * 0.18;
                if (confetti.y > viewportHeight - 120) {
                  const fadeOut =
                    1 -
                    Math.pow((confetti.y - (viewportHeight - 120)) / 120, 2);
                  el.style.opacity = Math.max(0, fadeOut * shimmer);
                } else {
                  el.style.opacity = shimmer;
                }
              } else if (confetti.element.parentNode) {
                confetti.element.parentNode.removeChild(confetti.element);
          }
        });
            if (activeConfetti)
              animationFrameId = requestAnimationFrame(animateAllConfetti);
            else
              confettiElements.forEach((confetti) => {
                if (confetti.element.parentNode)
                  confetti.element.parentNode.removeChild(confetti.element);
              });
          }
          animationFrameId = requestAnimationFrame(animateAllConfetti);
          setTimeout(() => {
            if (animationFrameId) {
              cancelAnimationFrame(animationFrameId);
              document.querySelectorAll(".confetti").forEach((el) => {
                if (el.parentNode) el.parentNode.removeChild(el);
              });
            }
          }, 8000);
        }
        window.addEventListener("resize", refitAllLines);
      });
    </script>
  </body>
</html>
