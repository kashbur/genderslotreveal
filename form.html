<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Customize Your Reveal Link</title>
    <style>
      :root {
        color-scheme: light;
        font-family: 'Poppins', system-ui, -apple-system, BlinkMacSystemFont,
          'Segoe UI', sans-serif;
        --accent: #5a5df0;
      }
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        min-height: 100vh;
        background: #f6f7fb;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: clamp(1.5rem, 4vw, 3.5rem);
      }
      main {
        width: min(1080px, 100%);
        display: grid;
        gap: clamp(1.75rem, 4vw, 3rem);
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        background: white;
        padding: clamp(1.75rem, 5vw, 3.5rem);
        border-radius: 24px;
        box-shadow: 0 18px 48px rgba(40, 52, 98, 0.12);
      }
      h1 {
        grid-column: 1 / -1;
        margin: 0;
        font-size: clamp(1.85rem, 4vw, 2.75rem);
        font-weight: 600;
        color: #1f2345;
        text-align: center;
      }
      form {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        position: relative;
      }
      label {
        display: block;
        font-weight: 600;
        font-size: 1rem;
        color: #1f2345;
        margin-bottom: 0.5rem;
      }
      fieldset {
        border: none;
        padding: 0;
        margin: 0;
      }
      .radio-group {
        display: grid;
        grid-template-columns: repeat(2, minmax(120px, 1fr));
        gap: 0.75rem;
      }
      .radio-option {
        display: flex;
        align-items: center;
        gap: 0.65rem;
        padding: 0.8rem 1rem;
        border-radius: 12px;
        border: 1px solid rgba(31, 35, 69, 0.12);
        background: #f9f9ff;
        cursor: pointer;
        transition: border-color 120ms ease, background 120ms ease,
          box-shadow 120ms ease;
      }
      .radio-option input[type='radio'] {
        width: 18px;
        height: 18px;
        accent-color: var(--accent);
      }
      .radio-option.active {
        border-color: rgba(90, 93, 240, 0.65);
        background: rgba(90, 93, 240, 0.08);
        box-shadow: 0 10px 24px rgba(90, 93, 240, 0.18);
      }
      textarea {
        width: 100%;
        min-height: 140px;
        border-radius: 16px;
        border: 1px solid rgba(31, 35, 69, 0.16);
        padding: 1rem 1.15rem;
        font-family: inherit;
        font-size: 1rem;
        resize: vertical;
        transition: border-color 120ms ease, box-shadow 120ms ease;
      }
      textarea:focus {
        border-color: rgba(90, 93, 240, 0.7);
        box-shadow: 0 0 0 4px rgba(90, 93, 240, 0.15);
        outline: none;
      }
      .language-controls {
        display: flex;
        justify-content: flex-end;
      }

      .actions {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
      }
      button.primary {
        border: none;
        border-radius: 999px;
        padding: 0.85rem 1.75rem;
        font-size: 1rem;
        font-weight: 600;
        background: var(--accent);
        color: white;
        cursor: pointer;
        transition: transform 120ms ease, box-shadow 120ms ease;
      }
      button.primary:hover,
      button.primary:focus-visible {
        transform: translateY(-2px);
        box-shadow: 0 14px 24px rgba(90, 93, 240, 0.3);
        outline: none;
      }
      .output {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }
      .output input[type='text'] {
        width: 100%;
        border-radius: 12px;
        border: 1px solid rgba(31, 35, 69, 0.16);
        padding: 0.85rem 1.15rem;
        font-size: 0.95rem;
      }
      .output-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
      }
      button.secondary {
        border: none;
        border-radius: 999px;
        padding: 0.75rem 1.5rem;
        font-size: 0.95rem;
        font-weight: 600;
        background: rgba(31, 35, 69, 0.08);
        color: #1f2345;
        cursor: pointer;
        transition: background 120ms ease, transform 120ms ease;
      }
      button.secondary:hover,
      button.secondary:focus-visible {
        background: rgba(31, 35, 69, 0.16);
        transform: translateY(-1px);
        outline: none;
      }
      button.secondary[disabled] {
        opacity: 0.55;
        cursor: not-allowed;
        transform: none;
      }
      section.preview {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      section.preview h2 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
        color: #1f2345;
      }

      .language-overlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 18, 45, 0.55);
        backdrop-filter: blur(6px);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: clamp(1.5rem, 5vw, 3rem);
        z-index: 999;
      }

      .language-overlay[hidden] {
        display: none;
      }

      .language-dialog {
        width: min(520px, 100%);
        background: white;
        border-radius: 24px;
        padding: clamp(1.75rem, 4vw, 2.75rem);
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        box-shadow: 0 28px 56px rgba(31, 35, 69, 0.25);
      }

      .language-dialog h2 {
        margin: 0;
        font-size: clamp(1.45rem, 4vw, 1.85rem);
        font-weight: 600;
        color: #1f2345;
        text-align: center;
      }

      .language-dialog p {
        margin: 0;
        color: rgba(31, 35, 69, 0.78);
        text-align: center;
        font-size: 0.95rem;
      }

      .language-options {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 0.75rem;
      }

      .language-overlay .radio-option {
        justify-content: center;
      }

      .visually-hidden {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }
      .preview-frame {
        aspect-ratio: 9 / 16;
        width: 100%;
        border-radius: 18px;
        border: 1px solid rgba(31, 35, 69, 0.12);
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.65);
      }
      @media (max-width: 760px) {
        main {
          grid-template-columns: 1fr;
        }
        .actions {
          flex-direction: column;
          align-items: stretch;
        }
        .actions button {
          width: 100%;
          text-align: center;
        }
      }
    </style>
  </head>
  <body>
    <main>
      <h1 id="formTitle">Customize Your Reveal Link</h1>
      <form id="revealForm">
        <div class="language-controls">
          <button
            type="button"
            class="secondary"
            id="changeLanguageButton"
            aria-haspopup="dialog"
          >
            Change Language
          </button>
        </div>
        <fieldset>
          <legend id="genderLabel">Boy or Girl?</legend>
          <div class="radio-group" role="radiogroup" aria-labelledby="genderLabel">
            <label class="radio-option gender-option active">
              <input type="radio" name="gender" value="1" checked />
              <span data-gender-option="boy">Boy</span>
            </label>
            <label class="radio-option gender-option">
              <input type="radio" name="gender" value="2" />
              <span data-gender-option="girl">Girl</span>
            </label>
          </div>
        </fieldset>
        <div>
          <label for="message" id="messageLabel">Reveal Message</label>
          <textarea id="message" placeholder="Reveal Message"></textarea>
        </div>
        <div class="actions">
          <button type="button" class="primary" id="generateButton">
            Generate URL
          </button>
        </div>
        <div class="output">
          <input
            type="text"
            id="resultUrl"
            readonly
            aria-live="polite"
            value="https://genderslotreveal.netlify.app/"
          />
          <div class="output-controls">
            <button
              type="button"
              class="secondary"
              id="copyButton"
              disabled
              aria-disabled="true"
            >
              Copy to Clipboard
            </button>
          </div>
        </div>
      </form>
      <section class="preview">
        <h2 id="previewHeading">Live Preview</h2>
        <iframe
          id="previewFrame"
          class="preview-frame"
          title="Preview"
          loading="lazy"
        ></iframe>
      </section>
    </main>
    <div
      class="language-overlay"
      id="languageOverlay"
      role="dialog"
      aria-modal="true"
      aria-labelledby="languageHeading"
      aria-describedby="languageDescription"
      hidden
    >
      <div class="language-dialog">
        <h2 id="languageHeading">Select a language</h2>
        <p id="languageDescription">Choose the language for this reveal experience.</p>
        <form id="languageForm">
          <fieldset>
            <legend class="visually-hidden">Available languages</legend>
            <div class="language-options">
              <label class="radio-option">
                <input type="radio" name="language" value="en" checked />
                <span data-language-name="en">English</span>
              </label>
              <label class="radio-option">
                <input type="radio" name="language" value="es" />
                <span data-language-name="es">Español</span>
              </label>
              <label class="radio-option">
                <input type="radio" name="language" value="fr" />
                <span data-language-name="fr">Français</span>
              </label>
              <label class="radio-option">
                <input type="radio" name="language" value="de" />
                <span data-language-name="de">Deutsch</span>
              </label>
            </div>
          </fieldset>
          <button type="submit" class="primary" id="languageConfirm">
            Continue
          </button>
        </form>
      </div>
    </div>
    <script>
      const translations = {
        en: {
          title: 'Customize Your Reveal Link',
          gender: 'Boy or Girl?',
          message: 'Reveal Message',
          generate: 'Generate URL',
          copy: 'Copy to Clipboard',
          boy: 'Boy',
          girl: 'Girl',
          preview: 'Live Preview',
          changeLanguage: 'Change Language',
          selectLanguageTitle: 'Select a language',
          selectLanguageDescription: 'Choose the language for this reveal experience.',
          confirmLanguage: 'Continue',
          languageNames: {
            en: 'English',
            es: 'Español',
            fr: 'Français',
            de: 'Deutsch',
          },
        },
        es: {
          title: 'Personaliza tu enlace',
          gender: '¿Niño o niña?',
          message: 'Mensaje de revelación',
          generate: 'Generar enlace',
          copy: 'Copiar',
          boy: 'Niño',
          girl: 'Niña',
          preview: 'Vista previa en vivo',
          changeLanguage: 'Cambiar idioma',
          selectLanguageTitle: 'Selecciona un idioma',
          selectLanguageDescription: 'Elige el idioma para esta revelación.',
          confirmLanguage: 'Continuar',
          languageNames: {
            en: 'English',
            es: 'Español',
            fr: 'Français',
            de: 'Deutsch',
          },
        },
        fr: {
          title: 'Personnalisez votre lien',
          gender: 'Garçon ou fille ?',
          message: 'Message de révélation',
          generate: 'Générer le lien',
          copy: 'Copier',
          boy: 'Garçon',
          girl: 'Fille',
          preview: 'Aperçu en direct',
          changeLanguage: 'Changer de langue',
          selectLanguageTitle: 'Sélectionnez une langue',
          selectLanguageDescription: 'Choisissez la langue de cette révélation.',
          confirmLanguage: 'Continuer',
          languageNames: {
            en: 'English',
            es: 'Español',
            fr: 'Français',
            de: 'Deutsch',
          },
        },
        de: {
          title: 'Passen Sie Ihren Link an',
          gender: 'Junge oder Mädchen?',
          message: 'Enthüllungsnachricht',
          generate: 'Link erstellen',
          copy: 'Kopieren',
          boy: 'Junge',
          girl: 'Mädchen',
          preview: 'Live-Vorschau',
          changeLanguage: 'Sprache ändern',
          selectLanguageTitle: 'Sprache auswählen',
          selectLanguageDescription: 'Wähle die Sprache für diese Enthüllung.',
          confirmLanguage: 'Weiter',
          languageNames: {
            en: 'English',
            es: 'Español',
            fr: 'Français',
            de: 'Deutsch',
          },
        },
      };

      const params = new URLSearchParams(window.location.search);
      const langParam = params.get('lang');
      let currentLang = translations[langParam] ? langParam : 'en';
      const shouldPromptForLanguage = !translations[langParam];
      const fallbackLanguageNames = translations.en.languageNames;

      const formTitle = document.getElementById('formTitle');
      const genderLabel = document.getElementById('genderLabel');
      const messageLabel = document.getElementById('messageLabel');
      const messageField = document.getElementById('message');
      const generateButton = document.getElementById('generateButton');
      const copyButton = document.getElementById('copyButton');
      const resultUrl = document.getElementById('resultUrl');
      const previewFrame = document.getElementById('previewFrame');
      const previewHeading = document.getElementById('previewHeading');
      const genderOptions = document.querySelectorAll('.gender-option');
      const boyLabel = document.querySelector('[data-gender-option="boy"]');
      const girlLabel = document.querySelector('[data-gender-option="girl"]');
      const changeLanguageButton = document.getElementById('changeLanguageButton');
      const languageOverlay = document.getElementById('languageOverlay');
      const languageForm = document.getElementById('languageForm');
      const languageInputs = languageForm.querySelectorAll('input[name="language"]');
      const languageNameElements = document.querySelectorAll('[data-language-name]');
      const languageHeading = document.getElementById('languageHeading');
      const languageDescription = document.getElementById('languageDescription');
      const languageConfirm = document.getElementById('languageConfirm');

      function setCopyAvailability(isEnabled) {
        copyButton.disabled = !isEnabled;
        copyButton.setAttribute('aria-disabled', String(!isEnabled));
        if (!isEnabled) {
          const locale = translations[currentLang] || translations.en || {};
          const originalText =
            copyButton.dataset.originalText || locale.copy || 'Copy to Clipboard';
          copyButton.textContent = originalText;
        }
      }

      function markNeedsGeneration() {
        setCopyAvailability(false);
      }

      function applyTranslations() {
        const t = translations[currentLang] || translations.en;
        document.documentElement.lang = currentLang;
        document.title = t.title;
        formTitle.textContent = t.title;
        genderLabel.textContent = t.gender;
        messageLabel.textContent = t.message;
        messageField.placeholder = t.message;
        generateButton.textContent = t.generate;
        copyButton.textContent = t.copy;
        copyButton.dataset.originalText = t.copy;
        boyLabel.textContent = t.boy;
        girlLabel.textContent = t.girl;
        previewHeading.textContent = t.preview;
        changeLanguageButton.textContent = t.changeLanguage;
        languageHeading.textContent = t.selectLanguageTitle;
        languageDescription.textContent = t.selectLanguageDescription;
        languageConfirm.textContent = t.confirmLanguage;

        languageNameElements.forEach((element) => {
          const code = element.dataset.languageName;
          const names = t.languageNames || {};
          element.textContent =
            names[code] || fallbackLanguageNames[code] || element.textContent;
        });
      }

      function b64EncodeUnicode(str) {
        return btoa(
          encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (_, p1) =>
            String.fromCharCode(parseInt(p1, 16))
          )
        );
      }

      function buildObfuscatedUrl() {
        const genderValue = (
          document.querySelector('input[name="gender"]:checked') || { value: '' }
        ).value;
        const messageValue = messageField.value || '';

        const innerParams = new URLSearchParams();
        innerParams.set('lang', currentLang);
        innerParams.set('gender', genderValue);
        innerParams.set('message', messageValue);

        const encoded = b64EncodeUnicode(innerParams.toString());
        return `https://genderslotreveal.netlify.app/?d=${encodeURIComponent(encoded)}`;
      }

      function updatePreview() {
        const url = buildObfuscatedUrl();
        resultUrl.value = url;
        previewFrame.src = url;
      }

      function setActiveRadio(targetLabel) {
        genderOptions.forEach((option) => {
          if (option === targetLabel) {
            option.classList.add('active');
          } else {
            option.classList.remove('active');
          }
        });
      }

      function syncLanguageSelection() {
        languageInputs.forEach((input) => {
          const label = input.closest('.radio-option');
          if (label) {
            label.classList.toggle('active', input.checked);
          }
        });
      }

      function updateLanguageInUrl() {
        const nextParams = new URLSearchParams(window.location.search);
        nextParams.set('lang', currentLang);
        const queryString = nextParams.toString();
        const newUrl = `${window.location.pathname}${queryString ? `?${queryString}` : ''}`;
        history.replaceState({}, '', newUrl);
      }

      function openLanguageOverlay() {
        languageInputs.forEach((input) => {
          input.checked = input.value === currentLang;
        });
        syncLanguageSelection();
        languageOverlay.hidden = false;
        const checked = languageForm.querySelector('input[name="language"]:checked');
        if (checked) {
          checked.focus();
        }
        document.body.style.overflow = 'hidden';
      }

      function closeLanguageOverlay() {
        if (languageOverlay.hidden) {
          return;
        }
        languageOverlay.hidden = true;
        document.body.style.overflow = '';
        changeLanguageButton.focus();
      }

      languageOverlay.addEventListener('click', (event) => {
        if (event.target === languageOverlay) {
          closeLanguageOverlay();
        }
      });

      function getOverlayFocusableElements() {
        return Array.from(
          languageOverlay.querySelectorAll(
            'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
          )
        ).filter((element) => !element.hasAttribute('disabled'));
      }

      languageOverlay.addEventListener('keydown', (event) => {
        if (event.key !== 'Tab') {
          return;
        }
        const focusableElements = getOverlayFocusableElements();
        if (!focusableElements.length) {
          return;
        }
        const first = focusableElements[0];
        const last = focusableElements[focusableElements.length - 1];
        if (event.shiftKey) {
          if (document.activeElement === first) {
            event.preventDefault();
            last.focus();
          }
        } else if (document.activeElement === last) {
          event.preventDefault();
          first.focus();
        }
      });

      document.addEventListener('focusin', (event) => {
        if (languageOverlay.hidden) {
          return;
        }
        if (!languageOverlay.contains(event.target)) {
          const focusTarget =
            languageForm.querySelector('input[name="language"]:checked') ||
            languageInputs[0] ||
            languageConfirm;
          if (focusTarget) {
            focusTarget.focus();
          }
        }
      });

      genderOptions.forEach((label) => {
        const input = label.querySelector('input[type="radio"]');
        input.addEventListener('change', () => {
          if (input.checked) {
            setActiveRadio(label);
            markNeedsGeneration();
            updatePreview();
          }
        });
      });

      languageInputs.forEach((input) => {
        input.addEventListener('change', () => {
          syncLanguageSelection();
        });
      });

      messageField.addEventListener('input', () => {
        markNeedsGeneration();
        updatePreview();
      });

      generateButton.addEventListener('click', () => {
        updatePreview();
        setCopyAvailability(true);
        resultUrl.focus();
        resultUrl.select();
      });

      copyButton.addEventListener('click', async () => {
        try {
          const originalText = copyButton.dataset.originalText || copyButton.textContent;
          await navigator.clipboard.writeText(resultUrl.value);
          copyButton.dataset.originalText = originalText;
          copyButton.textContent = `${originalText} ✓`;
          setTimeout(() => {
            copyButton.textContent = copyButton.dataset.originalText;
          }, 1400);
        } catch (error) {
          console.error('Clipboard copy failed', error);
        }
      });

      changeLanguageButton.addEventListener('click', () => {
        openLanguageOverlay();
      });

      languageForm.addEventListener('submit', (event) => {
        event.preventDefault();
        const selected = languageForm.querySelector('input[name="language"]:checked');
        if (!selected) {
          return;
        }
        const chosenLang = selected.value;
        if (!translations[chosenLang]) {
          return;
        }
        currentLang = chosenLang;
        applyTranslations();
        markNeedsGeneration();
        updatePreview();
        updateLanguageInUrl();
        closeLanguageOverlay();
      });

      window.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && !languageOverlay.hidden) {
          event.preventDefault();
          closeLanguageOverlay();
        }
      });

      applyTranslations();
      setCopyAvailability(false);
      updatePreview();

      if (shouldPromptForLanguage) {
        openLanguageOverlay();
      }
    </script>
  </body>
</html>
